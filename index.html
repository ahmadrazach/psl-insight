<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PSL Season 9 ‚Äì Search & Retrieval Metrics</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
      :root {
        --bg: #f6f7fb;
        --card: #fff;
        --muted: #6b7280;
        --line: #e5e7eb;
        --brand: #0ea5e9;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial,
          sans-serif;
        background: var(--bg);
        margin: 0;
      }
      header {
        padding: 24px 20px 8px;
      }
      h1 {
        margin: 0 0 6px 0;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 16px 40px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .section {
        padding: 16px;
      }
      label {
        font-size: 0.9rem;
        color: var(--muted);
      }
      input[type='text'],
      select,
      button {
        padding: 10px 12px;
        font-size: 15px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
      }
      button {
        background: var(--brand);
        color: #fff;
        border: none;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .hint {
        color: var(--muted);
        font-size: 0.9rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid var(--line);
        font-size: 14px;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #f9fafb;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--line);
        font-size: 12px;
        color: #111;
        background: #fff;
      }
      .good {
        background: #e7ffe7;
      }
      .metrics {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }
      .metric {
        background: #f8fafc;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 12px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      details {
        background: #f8fafc;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 12px;
      }
      .footer {
        color: var(--muted);
        font-size: 0.85rem;
        padding: 16px;
      }
    </style>
  </head>
  <body>
    <header class="wrap">
      <h1>PSL Season 9 ‚Äì Search & Retrieval Metrics</h1>
      <div class="hint">
        Free‚Äëtext search + filters + precision/recall on ball‚Äëby‚Äëball data
        (Feb‚ÄìMar¬†2024).
      </div>
    </header>

    <main class="wrap">
      <!-- Controls -->
      <div class="card section">
        <div class="row">
          <div>
            <label>Query</label><br />
            <input
              id="q"
              type="text"
              placeholder="e.g., 'Shaheen Afridi wickets at Gaddafi Stadium' "
              size="46"
            />
          </div>
          <div>
            <label>Season</label><br />
            <select id="season">
              <option value="">All</option>
            </select>
          </div>
          <div>
            <label>Team (batting/bowling)</label><br />
            <select id="team">
              <option value="">All</option>
            </select>
          </div>
          <div>
            <label>Venue</label><br />
            <select id="venue">
              <option value="">All</option>
            </select>
          </div>
          <div style="align-self: end">
            <button id="btnSearch">Search</button>
          </div>
        </div>
        <div class="row" style="margin-top: 10px">
          <div>
            <label>Retrieval label (for metrics)</label><br />
            <select id="label">
              <option value="batting">batting (runs_off_bat ‚â• 1)</option>
              <option value="wicket">wicket (wicket_type present)</option>
              <option value="extras">
                extras (wides/noballs/byes/legbyes/penalty)
              </option>
              <option value="other">other</option>
            </select>
          </div>
          <div>
            <label>CSV Source</label><br />
            <span class="pill" id="csvSource"
              >Attempting to fetch PSL_Season_09_dataset.csv‚Ä¶</span
            >
          </div>
          <div>
            <label>Or upload CSV</label><br />
            <input id="file" type="file" accept=".csv" />
          </div>
        </div>
      </div>

      <!-- Metrics & Stats -->
      <div class="grid" style="margin-top: 14px">
        <div class="card section">
          <h3 style="margin-top: 0">Precision & Recall</h3>
          <div class="metrics" id="metricsBox">
            <div class="metric">Precision: <strong id="prec">‚Äì</strong></div>
            <div class="metric">Recall: <strong id="rec">‚Äì</strong></div>
            <div class="metric">Top‚ÄëK: <strong id="topk">‚Äì</strong></div>
            <div class="metric">
              Relevant in set: <strong id="relevant">‚Äì</strong>
            </div>
          </div>
          <details style="margin-top: 10px">
            <summary>How scores are computed</summary>
            <div class="hint">
              Text for each ball is vectorized with <strong>TF‚ÄëIDF</strong>. We
              compute <strong>cosine similarity</strong> between your query
              vector and each ball vector. We rank by cosine and show Top‚ÄëK. The
              ‚Äúretrieval label‚Äù is auto‚Äëderived per row:<br />
              <code>batting</code> if runs_off_bat ‚â• 1; <code>wicket</code> if
              wicket_type present; <code>extras</code> if
              wides/noballs/byes/legbyes/penalty &gt; 0; else
              <code>other</code>.<br />
              <strong>Precision</strong> = TP / (TP + FP).
              <strong>Recall</strong> = TP / (TP + FN).
            </div>
          </details>
        </div>

        <div class="card section">
          <h3 style="margin-top: 0">Quick Stats (current filter/search set)</h3>
          <div id="stats" class="hint">‚Äì</div>
        </div>
      </div>

      <!-- Results -->
      <div class="card section" style="margin-top: 14px">
        <h3 style="margin-top: 0">Results</h3>
        <table>
          <thead>
            <tr>
              <th>Match / Over</th>
              <th>Teams & Venue</th>
              <th>Actors</th>
              <th>Event</th>
              <th>Score</th>
              <th>Match</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr>
              <td colspan="6" class="hint">
                Load a CSV or wait for <code>PSL_Season_09_dataset.csv</code> to
                be fetched.
              </td>
            </tr>
          </tbody>
        </table>
        <div class="footer">
          Match quality: üü¢‚ú® ‚â•0.80, üü¢ ‚â•0.50, üü° ‚â•0.20, üî¥ &lt;0.20
        </div>
      </div>
    </main>

    <script>
      /*** ---------- Utilities ---------- ***/
      const $ = (id) => document.getElementById(id)

      function tokenize(s) {
        return s
          .toLowerCase()
          .replace(/[^a-z0-9\s]/g, ' ')
          .split(/\s+/)
          .filter(Boolean)
      }
      function cosine(a, b) {
        let dot = 0,
          na = 0,
          nb = 0
        for (let i = 0; i < a.length; i++) {
          dot += a[i] * b[i]
          na += a[i] * a[i]
          nb += b[i] * b[i]
        }
        return dot / (Math.sqrt(na) * Math.sqrt(nb) || 1)
      }
      function matchEmoji(score) {
        if (score >= 0.8) return 'üü¢‚ú® Perfect'
        if (score >= 0.5) return 'üü¢ High'
        if (score >= 0.2) return 'üü° Medium'
        return 'üî¥ Low'
      }

      /*** ---------- Data & Index ---------- ***/
      let rows = [] // raw CSV rows (objects)
      let docs = [] // derived text docs with vectors
      let vocab = new Map() // token -> index
      let idf = {} // token -> idf
      let dim = 0

      function rowLabel(r) {
        const toNum = (x) => +x || 0
        const hasWicket =
          (r.wicket_type || '').trim().length > 0 ||
          (r.player_dismissed || '').trim().length > 0 ||
          (r.other_wicket_type || '').trim().length > 0 ||
          (r.other_player_dismissed || '').trim().length > 0
        const runs = toNum(r.runs_off_bat)
        const extras =
          toNum(r.wides) +
          toNum(r.noballs) +
          toNum(r.byes) +
          toNum(r.legbyes) +
          toNum(r.penalty)
        if (hasWicket) return 'wicket'
        if (runs >= 1) return 'batting'
        if (extras > 0) return 'extras'
        return 'other'
      }

      function rowText(r) {
        // Rich text field to index (tune as needed)
        const bits = [
          r.season,
          r.start_date,
          r.venue,
          r.batting_team,
          'vs',
          r.bowling_team,
          'striker',
          r.striker,
          'non_striker',
          r.non_striker,
          'bowler',
          r.bowler,
          'ball',
          r.ball,
          'runs',
          r.runs_off_bat,
          'extras',
          +r.wides + +r.noballs + +r.byes + +r.legbyes + +r.penalty || 0,
          'wicket',
          r.wicket_type,
          r.player_dismissed,
        ]
        return bits.filter(Boolean).join(' ')
      }

      function buildIndex() {
        // DF
        const df = {}
        docs.forEach((d) => {
          const seen = new Set()
          tokenize(d.text).forEach((t) => {
            if (!seen.has(t)) {
              df[t] = (df[t] || 0) + 1
              seen.add(t)
            }
          })
        })
        // IDF + vocab
        let idx = 0
        const N = docs.length
        for (const t in df) {
          idf[t] = Math.log(N / df[t])
          vocab.set(t, idx++)
        }
        dim = vocab.size
        // TF-IDF per doc
        docs.forEach((d) => {
          const vec = new Float32Array(dim)
          const tf = {}
          tokenize(d.text).forEach((t) => (tf[t] = (tf[t] || 0) + 1))
          for (const t in tf) {
            const j = vocab.get(t)
            if (j === undefined) continue
            vec[j] = tf[t] * (idf[t] || 0)
          }
          d.vec = vec
        })
      }

      function rebuildDocs() {
        docs = rows.map((r, i) => ({
          i,
          label: rowLabel(r),
          text: rowText(r),
          season: r.season || '',
          venue: r.venue || '',
          batting_team: r.batting_team || '',
          bowling_team: r.bowling_team || '',
        }))
        vocab.clear()
        idf = {}
        dim = 0
        buildIndex()
      }

      /*** ---------- CSV Load ---------- ***/
      function setFilters() {
        const seasons = [
          ...new Set(rows.map((r) => r.season).filter(Boolean)),
        ].sort()
        const venues = [
          ...new Set(rows.map((r) => r.venue).filter(Boolean)),
        ].sort()
        const teams = [
          ...new Set(
            rows
              .flatMap((r) => [r.batting_team, r.bowling_team])
              .filter(Boolean)
          ),
        ].sort()
        $('season').innerHTML =
          `<option value="">All</option>` +
          seasons.map((s) => `<option>${s}</option>`).join('')
        $('venue').innerHTML =
          `<option value="">All</option>` +
          venues.map((s) => `<option>${s}</option>`).join('')
        $('team').innerHTML =
          `<option value="">All</option>` +
          teams.map((s) => `<option>${s}</option>`).join('')
      }

      function parseCSVText(text) {
        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
        }).data
        // normalize numeric fields
        const toNum = (x) =>
          x === undefined || x === null || x === '' ? 0 : +x
        rows = parsed.map((r) => ({
          match_id: r.match_id,
          season: r.season,
          start_date: r.start_date,
          venue: r.venue,
          innings: r.innings,
          ball: r.ball, // string like "1.5"
          batting_team: r.batting_team,
          bowling_team: r.bowling_team,
          striker: r.striker,
          non_striker: r.non_striker,
          bowler: r.bowler,
          runs_off_bat: toNum(r.runs_off_bat),
          wides: toNum(r.wides),
          noballs: toNum(r.noballs),
          byes: toNum(r.byes),
          legbyes: toNum(r.legbyes),
          penalty: toNum(r.penalty),
          wicket_type: r.wicket_type || '',
          player_dismissed: r.player_dismissed || '',
          other_wicket_type: r.other_wicket_type || '',
          other_player_dismissed: r.other_player_dismissed || '',
        }))
        setFilters()
        rebuildDocs()
        $(
          'tbody'
        ).innerHTML = `<tr><td colspan="6" class="hint">CSV loaded. Type a query and click Search.</td></tr>`
      }

      async function tryFetchDefault() {
        $('csvSource').textContent = 'Fetching PSL_Season_09_dataset.csv‚Ä¶'
        try {
          const res = await fetch('PSL_Season_09_dataset.csv')
          if (!res.ok) throw new Error(res.statusText)
          const text = await res.text()
          parseCSVText(text)
          $('csvSource').textContent = 'Loaded: PSL_Season_09_dataset.csv'
        } catch (e) {
          $('csvSource').textContent =
            'No PSL_Season_09_dataset.csv found. Use Upload.'
        }
      }

      $('file').addEventListener('change', (e) => {
        const f = e.target.files[0]
        if (!f) return
        const reader = new FileReader()
        reader.onload = (ev) => {
          parseCSVText(ev.target.result)
          $('csvSource').textContent = `Loaded: ${f.name}`
        }
        reader.readAsText(f)
      })
      tryFetchDefault()

      /*** ---------- Search + Metrics + Stats ---------- ***/
      function applyFilters(indices) {
        const s = $('season').value,
          t = $('team').value,
          v = $('venue').value
        return indices.filter((i) => {
          const d = docs[i]
          const teamMatch = !t || d.batting_team === t || d.bowling_team === t
          const seasonMatch = !s || d.season === s
          const venueMatch = !v || d.venue === v
          return teamMatch && seasonMatch && venueMatch
        })
      }

      function quickStats(indices) {
        const toNum = (x) => +x || 0
        const subset = indices.map((i) => rows[docs[i].i])
        const totalBalls = subset.length
        let runs = 0,
          wickets = 0,
          fours = 0,
          sixes = 0
        const batterRuns = new Map()
        const bowlerWkts = new Map()
        subset.forEach((r) => {
          const rb = toNum(r.runs_off_bat)
          const ex =
            toNum(r.wides) +
            toNum(r.noballs) +
            toNum(r.byes) +
            toNum(r.legbyes) +
            toNum(r.penalty)
          runs += rb + ex
          if (r.wicket_type && r.wicket_type.trim().length > 0) {
            wickets++
            bowlerWkts.set(r.bowler, (bowlerWkts.get(r.bowler) || 0) + 1)
          }
          if (rb === 4) fours++
          if (rb === 6) sixes++
          batterRuns.set(r.striker, (batterRuns.get(r.striker) || 0) + rb)
        })
        const topBatters = [...batterRuns.entries()]
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
        const topBowlers = [...bowlerWkts.entries()]
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5)
        $('stats').innerHTML = `<div class="metrics">
       <div class="metric">Balls: <strong>${totalBalls}</strong></div>
       <div class="metric">Runs: <strong>${runs}</strong></div>
       <div class="metric">Wkts: <strong>${wickets}</strong></div>
       <div class="metric">4s: <strong>${fours}</strong></div>
       <div class="metric">6s: <strong>${sixes}</strong></div>
     </div>
     <div class="grid" style="margin-top:8px">
       <div>
         <strong>Top Batters (runs_off_bat)</strong><br/>
         <ol>${
           topBatters.map(([p, v]) => `<li>${p || '‚Äî'} ‚Äî ${v}</li>`).join('') ||
           '‚Äî'
         }</ol>
       </div>
       <div>
         <strong>Top Bowlers (wickets)</strong><br/>
         <ol>${
           topBowlers.map(([p, v]) => `<li>${p || '‚Äî'} ‚Äî ${v}</li>`).join('') ||
           '‚Äî'
         }</ol>
       </div>
     </div>`
      }

      function search() {
        if (docs.length === 0) {
          alert('Load a CSV first.')
          return
        }
        const q = $('q').value.trim()
        if (!q) {
          alert('Enter a query')
          return
        }

        // Build query vector
        const qVec = new Float32Array(dim)
        tokenize(q).forEach((t) => {
          const j = vocab.get(t)
          if (j !== undefined) {
            qVec[j] = idf[t] || 0
          }
        })

        // Rank all
        const allIdx = docs.map((_, i) => i)
        const filteredIdx = applyFilters(allIdx)

        // compute scores only for filtered
        const ranked = filteredIdx
          .map((i) => {
            const s = cosine(qVec, docs[i].vec)
            return { i, s }
          })
          .sort((a, b) => b.s - a.s)

        const topK = 10
        const top = ranked.slice(0, topK)

        // Metrics for chosen label on the FILTERED set
        const label = $('label').value
        const relevantSet = filteredIdx.filter((i) => docs[i].label === label)
        const truePos = top.filter((t) => docs[t.i].label === label).length
        const fp = top.length - truePos
        const fn = relevantSet.length - truePos
        const precision = truePos / (truePos + fp || 1)
        const recall = truePos / (truePos + fn || 1)

        $('prec').textContent = precision.toFixed(2)
        $('rec').textContent = recall.toFixed(2)
        $('topk').textContent = `${top.length}`
        $('relevant').textContent = `${relevantSet.length}`

        // Stats for the current TOP set (or the whole filtered set ‚Äî choose one)
        quickStats(top.map((t) => t.i))

        // Render rows
        if (top.length === 0) {
          $(
            'tbody'
          ).innerHTML = `<tr><td colspan="6" class="hint">No matches. Try different query/filters.</td></tr>`
          return
        }
        $('tbody').innerHTML = top
          .map(({ i, s }) => {
            const r = rows[docs[i].i]
            const event = []
            if (+r.runs_off_bat > 0) event.push(`Runs: ${r.runs_off_bat}`)
            const ex = +r.wides + +r.noballs + +r.byes + +r.legbyes + +r.penalty
            if (ex > 0) event.push(`Extras: ${ex}`)
            if ((r.wicket_type || '').trim().length > 0)
              event.push(
                `Wicket: ${r.wicket_type} ${
                  r.player_dismissed ? `(${r.player_dismissed})` : ''
                }`
              )

            const rowClass = s >= 0.5 ? 'class="good"' : ''
            return `<tr ${rowClass}>
      <td>
        <div><strong>${r.match_id || '‚Äî'}</strong></div>
        <div class="hint">${r.start_date || '‚Äî'} ‚Ä¢ Over ${r.ball || '‚Äî'}</div>
      </td>
      <td>
        <div><strong>${r.batting_team || '‚Äî'}</strong> vs <strong>${
              r.bowling_team || '‚Äî'
            }</strong></div>
        <div class="pill">${r.venue || '‚Äî'}</div>
      </td>
      <td>
        <div>Striker: <strong>${r.striker || '‚Äî'}</strong></div>
        <div>Non‚Äëstriker: ${r.non_striker || '‚Äî'}</div>
        <div>Bowler: ${r.bowler || '‚Äî'}</div>
      </td>
      <td>${event.join(' ‚Ä¢ ') || '‚Äî'}<div class="hint">${
              docs[i].label
            }</div></td>
      <td>${s.toFixed(3)}</td>
      <td>${matchEmoji(s)}</td>
    </tr>`
          })
          .join('')
      }

      // Enter to search
      $('q').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') search()
      })
      $('btnSearch').addEventListener('click', search)
    </script>
  </body>
</html>
