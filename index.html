<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PSL Insight ‚Äî Simple Search & Metrics</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
      :root {
        --bg: #f6f7fb;
        --card: #fff;
        --muted: #6b7280;
        --line: #e5e7eb;
        --brand: #0ea5e9;
      }
      body {
        font-family: system-ui, Segoe UI, Inter, Arial, sans-serif;
        background: var(--bg);
        margin: 0;
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }
      h1 {
        margin: 0 0 8px 0;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 14px 16px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      label {
        font-size: 0.9rem;
        color: var(--muted);
      }
      input[type='text'],
      select,
      button {
        padding: 10px 12px;
        font-size: 15px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #fff;
      }
      input[type='text'] {
        width: 420px;
      }
      button {
        background: var(--brand);
        color: #fff;
        border: none;
        cursor: pointer;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid var(--line);
        font-size: 14px;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #f9fafb;
      }
      .hint {
        color: var(--muted);
        font-size: 0.92rem;
      }
      .metric {
        display: inline-block;
        background: #f8fafc;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px 10px;
        margin-right: 8px;
        margin-bottom: 8px;
      }
      .good {
        background: #e7ffe7;
      }
      details {
        background: #f8fafc;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 8px 10px;
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <h1>PSL Insight</h1>
      <div class="hint">
        Search PSL Season¬†9 (Feb‚ÄìMar¬†2024) ball‚Äëby‚Äëball data. Type anything and
        choose what you want to find.
      </div>

      <!-- Controls -->
      <div class="card" style="margin-top: 12px">
        <div class="row">
          <div>
            <label>Search</label><br />
            <input
              id="q"
              type="text"
              placeholder="e.g., Shaheen Afridi wickets at Gaddafi Stadium"
            />
          </div>
          <div>
            <label>What are you looking for?</label><br />
            <select id="label">
              <option value="any">Anything</option>
              <option value="wicket">Wickets</option>
              <option value="batting">Runs off the bat</option>
              <option value="extras">
                Extras (wides/noballs/byes/legbyes/penalty)
              </option>
            </select>
          </div>
          <div
            style="
              align-self: end;
              display: flex;
              gap: 10px;
              align-items: center;
            "
          >
            <label
              class="hint"
              style="display: flex; gap: 6px; align-items: center"
            >
              <input id="filterByLabel" type="checkbox" />
              Only show these in results
            </label>
            <button id="btnSearch">Search</button>
          </div>
        </div>
        <div class="hint" style="margin-top: 6px">
          We auto‚Äëload <code>PSL_Season_09_dataset.csv</code> from this folder.
          No uploads or settings needed.
        </div>
      </div>

      <!-- Metrics -->
      <div class="card" style="margin-top: 12px">
        <h3 style="margin: 6px 0 8px">Precision & Recall (plain English)</h3>
        <div class="hint" style="margin-bottom: 8px">
          Out of the top results we show, <b>Precision</b> tells you how many
          actually match what you asked for. <b>Recall</b> tells you how many of
          all possible matching rows we managed to catch in those top results.
        </div>
        <div>
          <span class="metric">Precision: <strong id="prec">‚Äì</strong></span>
          <span class="metric">Recall: <strong id="rec">‚Äì</strong></span>
          <span class="metric">Top‚ÄëK shown: <strong id="topk">‚Äì</strong></span>
          <span class="metric"
            >All rows matching your choice:
            <strong id="relevant">‚Äì</strong></span
          >
        </div>
        <details style="margin-top: 8px">
          <summary>How the score works</summary>
          <div class="hint">
            We turn each ball‚Äôs info into text and use <b>TF‚ÄëIDF</b> to make
            vectors. Your query becomes a vector too. We compare with
            <b>cosine similarity</b> and rank the best matches (Top‚ÄëK = 10).
            Your ‚ÄúWhat are you looking for?‚Äù choice marks rows as:
            <ul>
              <li><b>Wickets</b>: any wicket_type present</li>
              <li><b>Runs off the bat</b>: runs_off_bat ‚â• 1</li>
              <li><b>Extras</b>: wides/noballs/byes/legbyes/penalty ‚â• 1</li>
              <li><b>Anything</b>: no label filter (metrics disabled)</li>
            </ul>
            Precision = TP / (TP + FP). &nbsp; Recall = TP / (TP + FN).
          </div>
        </details>
      </div>

      <!-- Quick stats -->
      <div class="card" style="margin-top: 12px">
        <h3 style="margin: 6px 0 8px">In these results (Top¬†10)</h3>
        <div id="stats" class="hint">
          Type a query to see totals for runs, wickets, 4s/6s, and top players.
        </div>
      </div>

      <!-- Results -->
      <div class="card" style="margin-top: 12px">
        <h3 style="margin: 6px 0 8px">Results</h3>
        <table>
          <thead>
            <tr>
              <th>Match / Over</th>
              <th>Teams</th>
              <th>Venue</th>
              <th>Players</th>
              <th>Event</th>
              <th>Score</th>
              <th>Match</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr>
              <td colspan="7" class="hint">
                Waiting for <code>PSL_Season_09_dataset.csv</code>‚Ä¶
              </td>
            </tr>
          </tbody>
        </table>
        <div class="hint" style="margin-top: 6px">
          Match quality legend: üü¢‚ú® ‚â•0.80, üü¢ ‚â•0.50, üü° ‚â•0.20, üî¥ &lt;0.20
        </div>
      </div>
    </main>

    <script>
      /* ===== Helpers ===== */
      const $ = (id) => document.getElementById(id)

      // small stopword set to reduce noise
      const STOP = new Set([
        'the',
        'a',
        'an',
        'in',
        'at',
        'on',
        'of',
        'and',
        'or',
        'to',
        'vs',
        'v',
        'with',
        'for',
        'from',
        'by',
        'over',
      ])

      function tokenize(s) {
        return s
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, ' ')
          .split(/\s+/)
          .filter((t) => t && !STOP.has(t))
      }
      function cosine(a, b) {
        let d = 0,
          na = 0,
          nb = 0
        for (let i = 0; i < a.length; i++) {
          d += a[i] * b[i]
          na += a[i] * a[i]
          nb += b[i] * b[i]
        }
        return d / (Math.sqrt(na) * Math.sqrt(nb) || 1)
      }
      function emoji(score) {
        if (score >= 0.8) return 'üü¢‚ú® Perfect'
        if (score >= 0.5) return 'üü¢ High'
        if (score >= 0.2) return 'üü° Medium'
        return 'üî¥ Low'
      }

      // normalize cricket phrasing in the query to tokens we index
      function normalizeQuery(q) {
        let s = q.toLowerCase()
        s = s
          .replace(/\b6s\b/g, ' sixes ')
          .replace(/\b6\b/g, ' six ')
          .replace(/\b4s\b/g, ' fours ')
          .replace(/\b4\b/g, ' four ')
          .replace(/\brun out\b/g, ' runout ')
          .replace(/\bno ?ball(s)?\b/g, ' noballs ')
          .replace(/\bleg ?bye(s)?\b/g, ' legbyes ')
        return s
      }

      /* ===== Data + Index ===== */
      let rows = [],
        docs = [],
        vocab = new Map(),
        idf = {},
        dim = 0

      function labelRow(r) {
        const n = (x) => +x || 0
        const wicket =
          (r.wicket_type || '').trim() ||
          (r.player_dismissed || '').trim() ||
          (r.other_wicket_type || '').trim() ||
          (r.other_player_dismissed || '').trim()
        if (wicket) return 'wicket'
        if (n(r.runs_off_bat) >= 1) return 'batting'
        if (
          n(r.wides) + n(r.noballs) + n(r.byes) + n(r.legbyes) + n(r.penalty) >
          0
        )
          return 'extras'
        return 'other'
      }

      function rowText(r) {
        const n = (x) => +x || 0
        const runs = n(r.runs_off_bat)
        const wides = n(r.wides),
          noballs = n(r.noballs),
          byes = n(r.byes),
          legbyes = n(r.legbyes),
          penalty = n(r.penalty)
        const extras = wides + noballs + byes + legbyes + penalty

        const wicket = (r.wicket_type || '').toLowerCase().trim()
        const wicketTokens = []
        if (wicket) {
          wicketTokens.push('wicket', 'out')
          if (wicket.includes('caught')) wicketTokens.push('caught')
          if (wicket.includes('bowled')) wicketTokens.push('bowled')
          if (wicket.includes('lbw')) wicketTokens.push('lbw')
          if (wicket.includes('run out')) wicketTokens.push('runout', 'run-out')
          if (wicket.includes('stumped')) wicketTokens.push('stumped')
          if (r.player_dismissed) wicketTokens.push(r.player_dismissed)
        }

        const runTokens = []
        if (runs > 0) runTokens.push('run', 'runs', String(runs))
        if (runs === 4) runTokens.push('four', 'fours', 'boundary', '4s')
        if (runs === 6) runTokens.push('six', 'sixes', '6s')

        const extraTokens = []
        if (wides) extraTokens.push('wide', 'wides')
        if (noballs) extraTokens.push('no-ball', 'noball', 'noballs')
        if (byes) extraTokens.push('bye', 'byes')
        if (legbyes) extraTokens.push('leg-bye', 'legbyes', 'leg-byes')
        if (penalty) extraTokens.push('penalty', 'penalties')
        if (extras) extraTokens.push('extras')

        return [
          r.start_date,
          r.venue,
          r.batting_team,
          'vs',
          r.bowling_team,
          'striker',
          r.striker,
          'non_striker',
          r.non_striker,
          'bowler',
          r.bowler,
          'over',
          r.ball,
          ...runTokens,
          ...extraTokens,
          ...wicketTokens,
        ]
          .filter(Boolean)
          .join(' ')
      }

      function rebuildDocs() {
        docs = rows.map((r, i) => ({ i, label: labelRow(r), text: rowText(r) }))
        // build vocab/idf
        const df = {}
        docs.forEach((d) => {
          const seen = new Set()
          tokenize(d.text).forEach((t) => {
            if (!seen.has(t)) {
              df[t] = (df[t] || 0) + 1
              seen.add(t)
            }
          })
        })
        vocab.clear()
        idf = {}
        let idx = 0
        const N = docs.length
        for (const t in df) {
          idf[t] = Math.log(N / df[t])
          vocab.set(t, idx++)
        }
        dim = vocab.size
        // doc vectors
        docs.forEach((d) => {
          const vec = new Float32Array(dim),
            tf = {}
          tokenize(d.text).forEach((t) => (tf[t] = (tf[t] || 0) + 1))
          for (const t in tf) {
            const j = vocab.get(t)
            if (j !== undefined) vec[j] = tf[t] * (idf[t] || 0)
          }
          d.vec = vec
        })
      }

      /* ===== CSV ===== */
      function parseCSV(text) {
        const data = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
        }).data
        const num = (x) => (x === '' || x == null ? 0 : +x)
        rows = data.map((r) => ({
          match_id: r.match_id,
          season: r.season,
          start_date: r.start_date,
          venue: r.venue,
          innings: r.innings,
          ball: r.ball,
          batting_team: r.batting_team,
          bowling_team: r.bowling_team,
          striker: r.striker,
          non_striker: r.non_striker,
          bowler: r.bowler,
          runs_off_bat: num(r.runs_off_bat),
          wides: num(r.wides),
          noballs: num(r.noballs),
          byes: num(r.byes),
          legbyes: num(r.legbyes),
          penalty: num(r.penalty),
          wicket_type: r.wicket_type || '',
          player_dismissed: r.player_dismissed || '',
          other_wicket_type: r.other_wicket_type || '',
          other_player_dismissed: r.other_player_dismissed || '',
        }))
        rebuildDocs()
        $(
          'tbody'
        ).innerHTML = `<tr><td colspan="7" class="hint">CSV loaded. Type a query and press Enter.</td></tr>`
      }
      ;(async function () {
        try {
          const res = await fetch('PSL_Season_09_dataset.csv')
          if (!res.ok) throw new Error(res.statusText)
          parseCSV(await res.text())
        } catch (e) {
          $(
            'tbody'
          ).innerHTML = `<tr><td colspan="7" class="hint">Place <code>PSL_Season_09_dataset.csv</code> beside this file.</td></tr>`
        }
      })()

      /* ===== Stats ===== */
      function statsFrom(indices) {
        const n = (x) => +x || 0
        let runs = 0,
          wkts = 0,
          fours = 0,
          sixes = 0,
          balls = indices.length
        const bats = new Map(),
          bowls = new Map()
        indices.forEach((i) => {
          const r = rows[docs[i].i]
          const ex =
            n(r.wides) + n(r.noballs) + n(r.byes) + n(r.legbyes) + n(r.penalty)
          runs += n(r.runs_off_bat) + ex
          if (n(r.runs_off_bat) === 4) fours++
          if (n(r.runs_off_bat) === 6) sixes++
          if ((r.wicket_type || '').trim()) {
            wkts++
            bowls.set(r.bowler, (bowls.get(r.bowler) || 0) + 1)
          }
          bats.set(r.striker, (bats.get(r.striker) || 0) + n(r.runs_off_bat))
        })
        const topBat = [...bats.entries()]
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
        const topBowl = [...bowls.entries()]
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
        $('stats').innerHTML = `
    Balls: <b>${balls}</b> &nbsp; Runs (incl extras): <b>${runs}</b> &nbsp; Wickets: <b>${wkts}</b> &nbsp; 4s: <b>${fours}</b> &nbsp; 6s: <b>${sixes}</b>
    <div style="margin-top:6px">
      <b>Top batters</b>: ${
        topBat.map(([p, v]) => `${p || '‚Äî'} ${v}`).join(', ') || '‚Äî'
      }<br/>
      <b>Top bowlers</b>: ${
        topBowl.map(([p, v]) => `${p || '‚Äî'} ${v}`).join(', ') || '‚Äî'
      }
    </div>`
      }

      /* ===== Search & Metrics ===== */
      function search() {
        if (docs.length === 0) {
          alert('CSV not loaded yet.')
          return
        }
        const queryRaw = $('q').value.trim()
        if (!queryRaw) {
          alert('Enter a query')
          return
        }

        const query = normalizeQuery(queryRaw)
        const qVec = new Float32Array(dim)
        tokenize(query).forEach((t) => {
          const j = vocab.get(t)
          if (j !== undefined) qVec[j] = idf[t] || 0
        })

        // score all docs
        const ranked = docs
          .map((d, i) => ({ i, s: cosine(qVec, d.vec) }))
          .sort((a, b) => b.s - a.s)

        const want = $('label').value
        const topK = 10

        // Optionally filter visible results by label before Top‚ÄëK
        let rankedForView = ranked
        if (want !== 'any' && $('filterByLabel').checked) {
          rankedForView = ranked.filter((t) => docs[t.i].label === want)
        }
        const top = rankedForView.slice(0, topK)

        // Metrics (skip if ‚ÄúAnything‚Äù)
        if (want === 'any') {
          $('prec').textContent = '‚Äì'
          $('rec').textContent = '‚Äì'
          $('topk').textContent = `${top.length}`
          $('relevant').textContent = '‚Äì'
        } else {
          const relevantAll = docs
            .map((d, i) => i)
            .filter((i) => docs[i].label === want)
          const tp = top.filter((t) => docs[t.i].label === want).length
          const fp = top.length - tp
          const fn = relevantAll.length - tp
          $('prec').textContent = (tp / (tp + fp || 1)).toFixed(2)
          $('rec').textContent = (tp / (tp + fn || 1)).toFixed(2)
          $('topk').textContent = `${top.length}`
          $('relevant').textContent = `${relevantAll.length}`
        }

        // Stats reflect what user sees
        statsFrom(top.map((t) => t.i))

        // Render
        if (top.length === 0) {
          $(
            'tbody'
          ).innerHTML = `<tr><td colspan="7" class="hint">No matches. Try different words or uncheck ‚ÄúOnly show these in results‚Äù.</td></tr>`
          return
        }
        $('tbody').innerHTML = top
          .map(({ i, s }) => {
            const r = rows[docs[i].i]
            const n = (x) => +x || 0
            const ex =
              n(r.wides) +
              n(r.noballs) +
              n(r.byes) +
              n(r.legbyes) +
              n(r.penalty)
            const ev = []
            if (n(r.runs_off_bat) > 0) ev.push(`Runs: ${r.runs_off_bat}`)
            if (ex > 0) ev.push(`Extras: ${ex}`)
            if ((r.wicket_type || '').trim())
              ev.push(
                `Wicket: ${r.wicket_type}${
                  r.player_dismissed ? ` (${r.player_dismissed})` : ''
                }`
              )
            const trClass = s >= 0.5 ? 'class="good"' : ''
            return `<tr ${trClass}>
      <td><b>${r.match_id || '‚Äî'}</b><div class="hint">${
              r.start_date || '‚Äî'
            } ‚Ä¢ Over ${r.ball || '‚Äî'}</div></td>
      <td><b>${r.batting_team || '‚Äî'}</b> vs <b>${
              r.bowling_team || '‚Äî'
            }</b></td>
      <td>${r.venue || '‚Äî'}</td>
      <td>Striker: <b>${r.striker || '‚Äî'}</b><br/>Non‚Äëstriker: ${
              r.non_striker || '‚Äî'
            }<br/>Bowler: ${r.bowler || '‚Äî'}</td>
      <td>${ev.join(' ‚Ä¢ ') || '‚Äî'}<div class="hint">${docs[i].label}</div></td>
      <td>${s.toFixed(3)}</td>
      <td>${emoji(s)}</td>
    </tr>`
          })
          .join('')
      }

      // Enter to search
      $('q').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') search()
      })
      $('btnSearch').addEventListener('click', search)
    </script>
  </body>
</html>
